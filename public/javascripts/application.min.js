(function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var d=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);function b(l){var g,j,e;var k,h,f;e=l.length;j=0;g="";while(j<e){k=l.charCodeAt(j++)&255;if(j==e){g+=a.charAt(k>>2);g+=a.charAt((k&3)<<4);g+="==";break}h=l.charCodeAt(j++);if(j==e){g+=a.charAt(k>>2);g+=a.charAt(((k&3)<<4)|((h&240)>>4));g+=a.charAt((h&15)<<2);g+="=";break}f=l.charCodeAt(j++);g+=a.charAt(k>>2);g+=a.charAt(((k&3)<<4)|((h&240)>>4));g+=a.charAt(((h&15)<<2)|((f&192)>>6));g+=a.charAt(f&63)}return g}function c(m){var l,k,h,f;var j,e,g;e=m.length;j=0;g="";while(j<e){do{l=d[m.charCodeAt(j++)&255]}while(j<e&&l==-1);if(l==-1){break}do{k=d[m.charCodeAt(j++)&255]}while(j<e&&k==-1);if(k==-1){break}g+=String.fromCharCode((l<<2)|((k&48)>>4));do{h=m.charCodeAt(j++)&255;if(h==61){return g}h=d[h]}while(j<e&&h==-1);if(h==-1){break}g+=String.fromCharCode(((k&15)<<4)|((h&60)>>2));do{f=m.charCodeAt(j++)&255;if(f==61){return g}f=d[f]}while(j<e&&f==-1);if(f==-1){break}g+=String.fromCharCode(((h&3)<<6)|f)}return g}if(!window.btoa){window.btoa=b}if(!window.atob){window.atob=c}})();var Canvas2Image=(function(){var k=false;var h=document.createElement("canvas");if(h.getContext("2d")){k=true}if(!k){return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}}}var c=!!(h.getContext("2d").getImageData);var d=!!(h.toDataURL);var a=!!(window.btoa);var e="image/octet-stream";var m=function(n){var o=parseInt(n.width);var p=parseInt(n.height);return n.getContext("2d").getImageData(0,0,o,p)};var f=function(p){var q="";if(typeof p=="string"){q=p}else{var n=p;for(var o=0;o<n.length;o++){q+=String.fromCharCode(n[o])}}return btoa(q)};var j=function(B){var s=[];var E=B.width;var p=B.height;s.push(66);s.push(77);var z=E*p*3+54;s.push(z%256);z=Math.floor(z/256);s.push(z%256);z=Math.floor(z/256);s.push(z%256);z=Math.floor(z/256);s.push(z%256);s.push(0);s.push(0);s.push(0);s.push(0);s.push(54);s.push(0);s.push(0);s.push(0);var u=[];u.push(40);u.push(0);u.push(0);u.push(0);var w=E;u.push(w%256);w=Math.floor(w/256);u.push(w%256);w=Math.floor(w/256);u.push(w%256);w=Math.floor(w/256);u.push(w%256);var n=p;u.push(n%256);n=Math.floor(n/256);u.push(n%256);n=Math.floor(n/256);u.push(n%256);n=Math.floor(n/256);u.push(n%256);u.push(1);u.push(0);u.push(24);u.push(0);u.push(0);u.push(0);u.push(0);u.push(0);var o=E*p*3;u.push(o%256);o=Math.floor(o/256);u.push(o%256);o=Math.floor(o/256);u.push(o%256);o=Math.floor(o/256);u.push(o%256);for(var D=0;D<16;D++){u.push(0)}var A=(4-((E*3)%4))%4;var H=B.data;var q="";var r=p;do{var F=E*(r-1)*4;var C="";for(var t=0;t<E;t++){var G=4*t;C+=String.fromCharCode(H[F+G+2]);C+=String.fromCharCode(H[F+G+1]);C+=String.fromCharCode(H[F+G])}for(var I=0;I<A;I++){C+=String.fromCharCode(0)}q+=C}while(--r);var v=f(s.concat(u))+f(q);return v};var b=function(n){document.location.href=n};var i=function(o,n){return"data:"+n+";base64,"+o};var l=function(n){var o=document.createElement("img");o.src=n;return o};var g=function(o,p,r){if(p&&r){var q=document.createElement("canvas");q.width=p;q.height=r;q.style.width=p+"px";q.style.height=r+"px";var n=q.getContext("2d");n.drawImage(o,0,0,o.width,o.height,0,0,p,r);return q}return o};return{saveAsPNG:function(o,n,p,s){if(!d){return false}var q=g(o,p,s);var r=q.toDataURL("image/png");if(n){return l(r)}else{b(r.replace("image/png",e))}return true},saveAsJPEG:function(o,n,p,t){if(!d){return false}var q=g(o,p,t);var s="image/jpeg";var r=q.toDataURL(s);if(r.indexOf(s)!=5){return false}if(n){return l(r)}else{b(r.replace(s,e))}return true},saveAsBMP:function(p,o,q,s){if(!(c&&a)){return false}var r=g(p,q,s);var t=m(r);var n=j(t);if(o){return l(i(n,"image/bmp"))}else{b(i(n,e))}return true}}})();if(!window.SI){var SI={}}SI.Files={htmlClass:"SI-FILES-STYLIZED",fileClass:"file",wrapClass:"cabinet",fini:false,able:false,init:function(){this.fini=true;var b=0;if(window.opera||(b&&b<5.5)||!document.getElementsByTagName){return}this.able=true;var a=document.getElementsByTagName("html")[0];a.className+=(a.className!=""?" ":"")+this.htmlClass},stylize:function(a){if(!this.fini){this.init()}if(!this.able){return}a.parentNode.file=a;a.parentNode.onmousemove=function(i){if(typeof i=="undefined"){i=window.event}if(typeof i.pageY=="undefined"&&typeof i.clientX=="number"&&document.documentElement){i.pageX=i.clientX+document.documentElement.scrollLeft;i.pageY=i.clientY+document.documentElement.scrollTop}var d=oy=0;var g=this;if(g.offsetParent){d=g.offsetLeft;oy=g.offsetTop;while(g=g.offsetParent){d+=g.offsetLeft;oy+=g.offsetTop}}var b=i.pageX-d;var j=i.pageY-oy;var c=this.file.offsetWidth;var f=this.file.offsetHeight;this.file.style.top=j-(f/2)+"px";this.file.style.left=b-(c-30)+"px"}},stylizeById:function(a){this.stylize(document.getElementById(a))},stylizeAll:function(){if(!this.fini){this.init()}if(!this.able){return}var a=document.getElementsByTagName("input");for(var c=0;c<a.length;c++){var b=a[c];if(b.type=="file"&&b.className.indexOf(this.fileClass)!=-1&&b.parentNode.className.indexOf(this.wrapClass)!=-1){this.stylize(b)}}}};function Grid(a){this.cell_size={x:12,y:12};this.size={x:0,y:0};this.cells=[];this.sprites=a;this.cell_spacing=0;this.max_width=600}Grid.prototype={optimize:function(){var d=true;var c=0;for(var e=0;e<this.size.y;++e){d=true;for(var a=0;a<this.size.x;++a){if(!this.cells[e][a].free){d=false;break}}if(d){break}}c=e;if(c!=0){this.size.y=c;Oozi.canvas.height=this.size.y*this.cell_size.y}var b=0;for(var e=0;e<this.size.y;++e){for(var a=0;a<this.size.x;++a){if(!this.cells[e][a].free&&a>b){b=a}}}if(b!=0){this.size.x=b+1;Oozi.canvas.width=this.size.x*this.cell_size.x}return 0},calc_size:function(){var c=null;var d={w:0,h:0};for(var b=0;b<this.sprites.length;++b){var a=this.sprites[b];if(!c||(a.w<c.w&&a.h<c.h)){c=a}d.w+=a.w;d.h+=a.h}this.cell_size.x=c.w+(c.w%2)+this.cell_spacing;this.cell_size.y=c.h+(c.h%2)+this.cell_spacing;this.size.x=parseInt(Math.ceil(d.w/this.cell_size.x));this.size.y=parseInt(Math.ceil(d.h/this.cell_size.y))},build:function(){for(var b=0;b<this.size.y;++b){this.cells[b]=[];for(var a=0;a<this.size.x;++a){this.cells[b][a]={free:true,sprite:null}}}},place:function(d){dim=d.toGrid(this.cell_size);candidates=[];for(var g=0;g<=this.size.y-dim.h;++g){for(var b=0;b<=this.size.x-dim.w;++b){if(this.cells[g][b].free){candidates.push({x:b,y:g});break}}}var c,b,g;for(c=0;c<candidates.length;++c){var e=candidates[c];cell=this.cells[e.y][e.x];var f=true;var a=true;for(b=e.x;b<dim.w;++b){for(g=e.y;g<dim.h;++g){if(!this.cells[g][b].free){a=false;break}}if(!a){break}}if(!a){continue}d.x=e.x*this.cell_size.x;d.y=e.y*this.cell_size.y;for(g=e.y;g<e.y+dim.h;++g){for(b=e.x;b<e.x+dim.w;++b){this.cells[g][b].free=false;this.cells[g][b].sprite=d}}cell.free=false;return}d.x=0;d.y=0},align:function(){this.calc_size();this.build();var a=this.sprites.sort(function(d,c){return(c.w+c.h)>(d.w+d.h)?1:-1});for(var b=0;b<a.length;++b){this.place(a[b])}a=[];this.optimize()}};Oozi=function(){this.canvas=document.getElementsByName("myCanvas")[0];this.context=this.canvas.getContext("2d");this.cssBox=document.getElementById("myCSSBox");this.grid=null;this.aligner=a;this.sprites=[];function a(){this.grid=new Grid(this.sprites);this.grid.align();Oozi.canvas.height=this.grid.size.y*this.grid.cell_size.y}function d(){aligner()}function c(){myCSSBox.innerHTML="";for(var f=0;f<this.sprites.length;++f){var e=this.sprites[f];var g=document.createElement("p");e.render(context);html="";html+='<label for="'+e.name+'">.'+e.name+" {</label>";html+="<br /><span>background-position: -"+e.x+"px -"+e.y+"px;</span>";html+="<br /><span>background-image: url(IMAGE_NAME.png);</span>";html+="<br /><span>background-repeat: no-repeat;</span>";html+="<br /><span>width: "+e.w+"px;</span>";html+="<br /><span>height: "+e.h+"px;</span>";html+="<br />}</p>";g.innerHTML=html;myCSSBox.appendChild(g)}}function b(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var e=this.canvas.width;this.canvas.width=1;this.canvas.width=e}return{log:function(e){console.log(e)},reset:function(){grid=null;sprites=[];b();myCSSBox.innerHTML="<p><label>.null {</label><br /><span>foo: bar;</span><br /> }</p>";document.getElementById("overlay").style.display="block"},addSprite:function(e){sprite=new Sprite(e,e.name);sprites.push(sprite)},render:function(){if(sprites.length==0){return}b();d();for(var e=0;e<sprites.length;++e){sprites[e].render(context)}c()},canvas:this.canvas,context:this.context}}();Sprite=function(a,c){this.name=b(c);this.img=a;this.w=this.img.width;this.h=this.img.height;this.x=0;this.y=0;this.aligned=false;function b(d){return d.slice(0,d.lastIndexOf(".")).toLowerCase().replace("-","_").replace(/\W/g,"")}};Sprite.prototype={toGrid:function(b){var a=b;return{x:Math.ceil(this.x/a.x),y:Math.ceil(this.y/a.y),w:Math.ceil(this.w/a.x),h:Math.ceil(this.h/a.y)}},toString:function(){return"["+this.x+","+this.y+"], my dimensions are ["+this.w+","+this.h+"]"},render:function(a){a.drawImage(this.img,this.x,this.y)}};window.onload=function(){var f=document.getElementById("files-upload"),g=document.getElementById("dropbox"),a=document.getElementById("info"),d=document.getElementById("overlay"),b=document.getElementById("save");var j=0;var c=0;b.addEventListener("click",function(){Canvas2Image.saveAsPNG(Oozi.canvas);return false},false);function i(k){if(typeof FileReader!=="undefined"&&(/image/i).test(k.type)){img=new Image();reader=new FileReader();reader.onload=(function(l){return function(m){l.src=m.target.result;l.onload=function(){l.name=k.name;Oozi.addSprite(l);if(++c==j){Oozi.render();j=0;c=0}}}}(img));reader.readAsDataURL(k)}}function h(n){d.style.display="none";if(typeof n!=="undefined"){j=n.length;for(var m=0,k=n.length;m<k;m++){i(n[m])}}else{g.innerHTML="No support for the File API in this web browser"}}f.addEventListener("change",function(){h(this.files)},false);g.addEventListener("dragleave",function(k){var l=k.target;this.className=this.className.replace(" over","");if(l&&l===g){}k.preventDefault();k.stopPropagation()},false);g.addEventListener("dragenter",function(k){this.className+=" over";k.preventDefault();k.stopPropagation()},false);g.addEventListener("dragover",function(k){k.preventDefault();k.stopPropagation()},false);g.addEventListener("drop",function(k){this.className=this.className.replace(" over","");h(k.dataTransfer.files);k.preventDefault();k.stopPropagation()},false);document.getElementById("reset").addEventListener("click",function(k){Oozi.reset()},false);var e={canvas:document.getElementById("canvas-caption"),info:document.getElementById("info-caption")};e.info.addEventListener("click",function(k){g.style.display="none";a.style.display="block";e.info.className+=" selected";e.canvas.className=e.canvas.className.replace(" selected","")},false);e.canvas.addEventListener("click",function(k){g.style.display="block";a.style.display="none";e.canvas.className+=" selected";e.info.className=e.info.className.replace(" selected","")},false);SI.Files.stylizeAll()};