function Grid(a){this.cell_size={x:12,y:12};this.size={x:0,y:0};this.cells=[];this.sprites=sprites;this.cell_spacing=0;this.max_width=600}Grid.prototype={optimize:function(){var d=true;var c=0;var b=0;for(var e=0;e<this.size.y;++e){d=true;for(var a=0;a<this.size.x;++a){if(!this.cells[e][a].free){d=false;break}}if(d){break}}c=e;if(c!=0){this.size.y=c;myCanvas.height=this.size.y*this.cell_size.y}for(var e=0;e<this.size.y;++e){for(var a=0;a<this.size.x;++a){if(!this.cells[e][a].free&&a>b){b=a}}}if(b!=0){this.size.x=b+1;myCanvas.width=this.size.x*this.cell_size.x}return 0},calc_size:function(){var a=null;var b={w:0,h:0};$.each(this.sprites,function(c,d){if(!a||(d.w<a.w&&d.h<a.h)){a=d}b.w+=d.w;b.h+=d.h});this.cell_size.x=a.w+(a.w%2)+this.cell_spacing;this.cell_size.y=a.h+(a.h%2)+this.cell_spacing;if(b.w>this.max_width){b.w=this.max_width}this.size.x=parseInt(Math.ceil(b.w/this.cell_size.x));this.size.y=parseInt(Math.ceil(b.h/this.cell_size.y))},build:function(){for(var b=0;b<this.size.y;++b){this.cells[b]=[];for(var a=0;a<this.size.x;++a){this.cells[b][a]={free:true,sprite:null}}}},find_pos:function(c){dim=c.toGrid(this.cell_size);candidates=[];for(var g=0;g<=this.size.y-dim.h;++g){for(var b=0;b<=this.size.x-dim.w;++b){if(this.cells[g][b].free){candidates.push({x:b,y:g});break}}}for(var f=0;f<candidates.length;++f){var d=candidates[f];cell=this.cells[d.y][d.x];var e=true;var a=true;for(var b=d.x;b<dim.w;++b){for(var g=d.y;g<dim.h;++g){if(!this.cells[g][b].free){a=false;break}}if(!a){break}}if(!a){continue}c.x=d.x*this.cell_size.x;c.y=d.y*this.cell_size.y;for(var g=d.y;g<d.y+dim.h;++g){for(var b=d.x;b<d.x+dim.w;++b){this.cells[g][b].free=false;this.cells[g][b].sprite=c}}cell.free=false;return}console.log("WARNING: SHOULD NOT BE HERE");return{x:0,y:0}},place:function(a){this.find_pos(a)},align:function(){this.calc_size();this.build();sprites=this.sprites.sort(function(d,c){return(c.w+c.h)>(d.w+d.h)?1:-1});var a=this;$.each(sprites,function(b,c){a.place(c)});this.optimize()}};var myCanvas=document.getElementById("myCanvas");var myContext=myCanvas.getContext("2d");Oozi=function(){this.aligner=a;this.sprites=[];this.grid=null;function b(){console.log("aligning as a staircase");var h={h:0,w:0};var j,g=null;$.each(sprites,function(i,k){j=(!j||j.h<k.h)?k:j;g=(!g||g.w<k.w)?k:g});h.h=j.h;h.w=g.w;Oozi.log("Boundaries determined: Width: "+h.w+", Height: "+h.h);aligned={hor:[],ver:[]};$.each(sprites,function(i,k){list=(k.h>k.w)?"ver":"hor";aligned[list].push(k)});Oozi.log("We have "+aligned.hor.length+" horizontal elements");Oozi.log("We have "+aligned.ver.length+" vertical elements");aligned.hor.sort(function(k,i){i.w-k.w});aligned.ver.sort(function(k,i){i.h-k.h});aligned.all=[];for(var f=0;f<sprites.length;f){if(aligned.ver.length!=0){aligned.all.push(aligned.ver[0]);aligned.ver.shift();++f}if(aligned.hor.length!=0){aligned.all.push(aligned.hor[0]);aligned.hor.shift();++f}}offset={x:0,y:0};$.each(aligned.all,function(i,k){k.x=offset.x;k.y=offset.y;if(i%2==0){offset.x+=k.w}else{if(offset.y+k.h<h.w&&i+1!=aligned.all.length&&h.w-(offset.y+k.h)>aligned.all[i+1].h){console.log("offset y : "+offset.y+", sprite h : "+k.h)}else{console.log("offset y : "+offset.y);offset.y+=k.h}}});myCanvas.width=offset.x+aligned.all[aligned.all.length-1].w;myCanvas.height=offset.y;return true}function a(){console.log("aligning on a grid");this.grid=new Grid(sprites);this.grid.align();myCanvas.height=this.grid.size.y*this.grid.cell_size.y}function e(){this.aligner()}function d(){var f=$("#myCSSBox");f.empty();$.each(this.sprites,function(g,h){h.render(myContext);html="<p class='css-class' id='"+h.name+"'>";html+="<label for='"+h.name+"'>."+h.name+" {</label>";html+="<br /><span class='css-directive'>background-position: "+h.x+"px "+h.y+"px;</span>";html+="<br /><span class='css-directive'>background-image: url(IMAGE_NAME.png);</span>";html+="<br /><span class='css-directive'>background-repeat: no-repeat;</span>";html+="<br /><span class='css-directive'>width: "+this.w+"px;</span>";html+="<br /><span class='css-directive'>height: "+this.h+"px;</span>";html+="<br />}</p>";f.append(html)})}function c(h,g){myContext.clearRect(0,0,myCanvas.width,myCanvas.height);var f=myCanvas.width;myCanvas.width=1;myCanvas.width=f}return{log:function(f){console.log(f)},addSprite:function(f){sprite=new Sprite(f,f.name);sprites.push(sprite)},render:function(){if(sprites.length==0){return}c();e();$.each(sprites,function(f,g){g.render(myContext)});d()},chooseScheme:function(f){if(f=="vertical"){aligner=align_vertically}else{if(f=="staircase"){aligner=b}else{aligner=a}}myCanvas.width=600;myCanvas.height=480;this.render()},sprites:this.sprites,grid:this.grid,aligner:this.aligner}}();Sprite=function(a,c){this.name=b(c);this.img=a;this.w=this.img.width;this.h=this.img.height;this.x=0;this.y=0;this.aligned=false;function b(d){return d.slice(0,d.lastIndexOf(".")).toLowerCase().replace("-","_").replace(/\W/g,"")}};Sprite.prototype={toGrid:function(b){var a=b;return{x:Math.ceil(this.x/a.x),y:Math.ceil(this.y/a.y),w:Math.ceil(this.w/a.x),h:Math.ceil(this.h/a.y)}},toString:function(){return"["+this.x+","+this.y+"], my dimensions are ["+this.w+","+this.h+"]"},render:function(a){a.drawImage(this.img,this.x,this.y)}};$(function(){var a=document.getElementById("files-upload"),c=document.getElementById("dropbox"),f=document.getElementById("save");var e=0;var g=0;f.addEventListener("click",function(){Canvas2Image.saveAsPNG(myCanvas);return false},false);function d(h){if(typeof FileReader!=="undefined"&&(/image/i).test(h.type)){img=new Image();reader=new FileReader();reader.onload=(function(i){return function(j){i.src=j.target.result;i.onload=function(){i.name=h.name;Oozi.addSprite(i);if(++g==e){Oozi.render();e=0;g=0}}}}(img));reader.readAsDataURL(h)}}function b(k){if(typeof k!=="undefined"){e=k.length;for(var j=0,h=k.length;j<h;j++){d(k[j])}}else{c.innerHTML="No support for the File API in this web browser"}}a.addEventListener("change",function(){b(this.files)},false);c.addEventListener("dragleave",function(h){var i=h.target;this.className=this.className.replace(" over","");if(i&&i===c){}h.preventDefault();h.stopPropagation()},false);c.addEventListener("dragenter",function(h){$("#dropbox").addClass("over");h.preventDefault();h.stopPropagation()},false);c.addEventListener("dragover",function(h){h.preventDefault();h.stopPropagation()},false);c.addEventListener("drop",function(h){$("#dropbox").removeClass("over");$("#overlay").hide();b(h.dataTransfer.files);h.preventDefault();h.stopPropagation()},false);$("#align-grid").click(function(){Oozi.chooseScheme("grid")});$("#align-staircase").click(function(){Oozi.chooseScheme("staircase")});SI.Files.stylizeAll()});