function Grid(a){this.cell_size={x:12,y:12};this.size={x:0,y:0};this.cells=[];this.sprites=a;this.cell_spacing=0;this.max_width=600}Grid.prototype={optimize:function(){var d=true;var c=0;for(var e=0;e<this.size.y;++e){d=true;for(var a=0;a<this.size.x;++a){if(!this.cells[e][a].free){d=false;break}}if(d){break}}c=e;if(c!=0){this.size.y=c;Oozi.canvas.height=this.size.y*this.cell_size.y}var b=0;for(var e=0;e<this.size.y;++e){for(var a=0;a<this.size.x;++a){if(!this.cells[e][a].free&&a>b){b=a}}}if(b!=0){this.size.x=b+1;Oozi.canvas.width=this.size.x*this.cell_size.x}return 0},calc_size:function(){var c=null;var d={w:0,h:0};for(var b=0;b<this.sprites.length;++b){var a=this.sprites[b];if(!c||(a.w<c.w&&a.h<c.h)){c=a}d.w+=a.w;d.h+=a.h}this.cell_size.x=c.w+(c.w%2)+this.cell_spacing;this.cell_size.y=c.h+(c.h%2)+this.cell_spacing;this.size.x=parseInt(Math.ceil(d.w/this.cell_size.x));this.size.y=parseInt(Math.ceil(d.h/this.cell_size.y))},build:function(){for(var b=0;b<this.size.y;++b){this.cells[b]=[];for(var a=0;a<this.size.x;++a){this.cells[b][a]={free:true,sprite:null}}}},place:function(d){dim=d.toGrid(this.cell_size);candidates=[];for(var g=0;g<=this.size.y-dim.h;++g){for(var b=0;b<=this.size.x-dim.w;++b){if(this.cells[g][b].free){candidates.push({x:b,y:g});break}}}var c,b,g;for(c=0;c<candidates.length;++c){var e=candidates[c];cell=this.cells[e.y][e.x];var f=true;var a=true;for(b=e.x;b<dim.w;++b){for(g=e.y;g<dim.h;++g){if(!this.cells[g][b].free){a=false;break}}if(!a){break}}if(!a){continue}d.x=e.x*this.cell_size.x;d.y=e.y*this.cell_size.y;for(g=e.y;g<e.y+dim.h;++g){for(b=e.x;b<e.x+dim.w;++b){this.cells[g][b].free=false;this.cells[g][b].sprite=d}}cell.free=false;return}d.x=0;d.y=0},align:function(){this.calc_size();this.build();var a=this.sprites.sort(function(d,c){return(c.w+c.h)>(d.w+d.h)?1:-1});for(var b=0;b<a.length;++b){this.place(a[b])}a=[];this.optimize()}};Oozi=function(){this.canvas=document.getElementsByName("myCanvas")[0];this.context=this.canvas.getContext("2d");this.cssBox=document.getElementById("myCSSBox");this.grid=null;this.aligner=a;this.sprites=[];function a(){this.grid=new Grid(this.sprites);this.grid.align();Oozi.canvas.height=this.grid.size.y*this.grid.cell_size.y}function d(){aligner()}function c(){myCSSBox.innerHTML="";for(var f=0;f<this.sprites.length;++f){var e=this.sprites[f];var g=document.createElement("p");e.render(context);html="";html+='<label for="'+e.name+'">.'+e.name+" {</label>";html+="<br /><span>background-position: -"+e.x+"px -"+e.y+"px;</span>";html+="<br /><span>background-image: url(IMAGE_NAME.png);</span>";html+="<br /><span>background-repeat: no-repeat;</span>";html+="<br /><span>width: "+e.w+"px;</span>";html+="<br /><span>height: "+e.h+"px;</span>";html+="<br />}</p>";g.innerHTML=html;myCSSBox.appendChild(g)}}function b(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var e=this.canvas.width;this.canvas.width=1;this.canvas.width=e}return{log:function(e){console.log(e)},reset:function(){grid=null;sprites=[];b();myCSSBox.innerHTML="<p><label>.null {</label><br /><span>foo: bar;</span><br /> }</p>";document.getElementById("overlay").style.display="block"},addSprite:function(e){sprite=new Sprite(e,e.name);sprites.push(sprite)},render:function(){if(sprites.length==0){return}b();d();for(var e=0;e<sprites.length;++e){sprites[e].render(context)}c()},canvas:this.canvas,context:this.context}}();Sprite=function(a,c){this.name=b(c);this.img=a;this.w=this.img.width;this.h=this.img.height;this.x=0;this.y=0;this.aligned=false;function b(d){return d.slice(0,d.lastIndexOf(".")).toLowerCase().replace("-","_").replace(/\W/g,"")}};Sprite.prototype={toGrid:function(b){var a=b;return{x:Math.ceil(this.x/a.x),y:Math.ceil(this.y/a.y),w:Math.ceil(this.w/a.x),h:Math.ceil(this.h/a.y)}},toString:function(){return"["+this.x+","+this.y+"], my dimensions are ["+this.w+","+this.h+"]"},render:function(a){a.drawImage(this.img,this.x,this.y)}};window.onload=function(){var f=document.getElementById("files-upload"),g=document.getElementById("dropbox"),a=document.getElementById("info"),d=document.getElementById("overlay"),b=document.getElementById("save");var j=0;var c=0;b.addEventListener("click",function(){Canvas2Image.saveAsPNG(Oozi.canvas);return false},false);function i(k){if(typeof FileReader!=="undefined"&&(/image/i).test(k.type)){img=new Image();reader=new FileReader();reader.onload=(function(l){return function(m){l.src=m.target.result;l.onload=function(){l.name=k.name;Oozi.addSprite(l);if(++c==j){Oozi.render();j=0;c=0}}}}(img));reader.readAsDataURL(k)}}function h(n){d.style.display="none";if(typeof n!=="undefined"){j=n.length;for(var m=0,k=n.length;m<k;m++){i(n[m])}}else{g.innerHTML="No support for the File API in this web browser"}}f.addEventListener("change",function(){h(this.files)},false);g.addEventListener("dragleave",function(k){var l=k.target;this.className=this.className.replace(" over","");if(l&&l===g){}k.preventDefault();k.stopPropagation()},false);g.addEventListener("dragenter",function(k){this.className+=" over";k.preventDefault();k.stopPropagation()},false);g.addEventListener("dragover",function(k){k.preventDefault();k.stopPropagation()},false);g.addEventListener("drop",function(k){this.className=this.className.replace(" over","");h(k.dataTransfer.files);k.preventDefault();k.stopPropagation()},false);document.getElementById("reset").addEventListener("click",function(k){Oozi.reset()},false);var e={canvas:document.getElementById("canvas-caption"),info:document.getElementById("info-caption")};e.info.addEventListener("click",function(k){g.style.display="none";a.style.display="block";e.info.className+=" selected";e.canvas.className=e.canvas.className.replace(" selected","")},false);e.canvas.addEventListener("click",function(k){g.style.display="block";a.style.display="none";e.canvas.className+=" selected";e.info.className=e.info.className.replace(" selected","")},false);SI.Files.stylizeAll()};